<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë™ë¬¼ ìˆ²ì˜ ìˆ˜í•™ ì—°ê¸ˆìˆ ì‚¬ : Final Fixed</title>
    <style>
        :root { --primary: #00897b; --secondary: #b2dfdb; --accent: #ff7043; --bg: #e0f2f1; --text: #004d40; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; user-select: none; color: var(--text); }
        
        #header { width: 760px; display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 15px; border: 3px solid var(--secondary); }
        .score-box { font-size: 20px; font-weight: bold; }
        
        #game-board { 
            display: grid; grid-template-columns: repeat(5, 140px); grid-template-rows: repeat(2, 160px); 
            gap: 15px; background: white; padding: 20px; border-radius: 25px; border: 5px solid #80cbc4; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); position: relative;
        }
        
        .slot-box { 
            border: 3px solid #eee; border-radius: 18px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            background: #fff; position: relative; transition: 0.3s; cursor: pointer; overflow: hidden;
        }
        .slot-box:hover { transform: translateY(-5px); border-color: var(--accent); }
        .treasure-icon { font-size: 55px; margin-bottom: 5px; }
        .req-icons { font-size: 14px; background: rgba(0,0,0,0.05); padding: 3px 8px; border-radius: 10px; }
        
        .warning-mid { box-shadow: inset 0 0 20px #fff176; border-color: #fdd835; animation: pulse 1s infinite; }
        .warning-high { box-shadow: inset 0 0 30px #ef5350; border-color: #f44336; animation: shake 0.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-2px, 2px); } 75% { transform: translate(2px, -2px); } }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ & ì¸ë²¤í† ë¦¬ */
        #control-panel { width: 760px; height: 130px; background: white; margin-top: 15px; border-radius: 20px; display: flex; justify-content: space-around; align-items: center; border: 3px solid var(--secondary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        #m-display { font-size: 15px; background: #e0f7fa; padding: 10px 15px; border-radius: 15px; border: 2px solid #b2ebf2; font-weight: bold; }
        
        #inventory { display: flex; gap: 20px; background: #e0f2f1; padding: 15px; border-radius: 15px; border: 2px solid #b2dfdb; }
        .inv-slot { width: 65px; height: 65px; border: 3px dashed #80cbc4; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; background: white; transition: 0.2s; position: relative; }
        .inv-slot:hover { transform: scale(1.05); border-color: var(--accent); }
        .inv-slot.filled { border-style: solid; background: #fffde7; animation: pop 0.3s; border-color: #fbc02d; }
        
        /* ì–¼ìŒ í¬ì…˜ ì£¼ë¨¸ë‹ˆ ìŠ¤íƒ€ì¼ */
        #ice-pouch { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 75px; height: 90px; background: #e1f5fe; border: 3px solid #29b6f6; border-radius: 15px; cursor: pointer; transition: 0.2s; 
        }
        #ice-pouch:hover { transform: scale(1.05); background: #b3e5fc; }
        #ice-pouch.disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: grayscale(1); }
        .ice-count { font-size: 14px; font-weight: bold; color: #0277bd; margin-top: 5px; }

        .btn-group { display: flex; gap: 8px; flex-direction: column; }
        button { padding: 10px 15px; border-radius: 12px; border: none; font-weight: bold; font-size: 15px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.1); width: 140px; }
        button:active { transform: translateY(4px); box-shadow: none; }
        .btn-green { background: #26a69a; color: white; }
        .btn-orange { background: #ff7043; color: white; }
        .btn-disabled { background: #cfd8dc; color: #90a4ae; cursor: not-allowed; transform: none !important; box-shadow: none !important; position: relative; }
        .btn-disabled::after { content: "â›”"; position: absolute; top: -8px; right: -5px; font-size: 18px; }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; backdrop-filter: blur(3px); }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 25px; z-index: 100; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.2); min-width: 400px; border: 4px solid var(--primary); }
        
        input { font-size: 24px; text-align: center; padding: 10px; border: 2px solid #ddd; border-radius: 10px; outline: none; background: #fafafa; }
        input:focus { border-color: var(--accent); background: #fff; }

        #input-single input { width: 150px; }
        .fraction-box { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .fraction-box input { width: 70px; height: 50px; }
        .frac-line { width: 80px; height: 3px; background: #5d4037; border-radius: 2px; }
        .mixed-box { display: flex; align-items: center; justify-content: center; gap: 15px; }
        .whole-num-input { width: 70px; height: 70px; font-size: 30px; }

        #feedback-overlay { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; font-weight: bold; pointer-events: none; z-index: 3000; text-shadow: 0 5px 15px rgba(0,0,0,0.3); opacity: 0; white-space: nowrap; }
        .success-anim { animation: pop-success 1.5s ease-out forwards; color: #4caf50; }
        .fail-anim { animation: pop-success 1.5s ease-out forwards; color: #f44336; }
        @keyframes pop-success { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }

        #fox-toast { display: none; position: fixed; top: 10%; background: rgba(0,0,0,0.85); color: white; padding: 15px 25px; border-radius: 30px; font-weight: bold; z-index: 2000; animation: fade-in 0.3s; white-space: pre-line; text-align: center; line-height: 1.5; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes fade-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .item-card { background: #fff3e0; border: 2px solid #ffb74d; border-radius: 15px; padding: 15px; margin-top: 10px; animation: pop 0.5s; }
        .item-name { font-size: 18px; font-weight: bold; color: #ef6c00; margin: 10px 0; }
        .item-rank { font-size: 14px; color: #777; }
        
        /* [ìˆ˜ì •ë¨] ê¸€ì ì¤„ë°”ê¿ˆ ë°©ì§€ ì¶”ê°€ */
        #collection-btn { 
            position: fixed; bottom: 20px; right: 20px; 
            background: #00796b; color: white; padding: 10px 20px; 
            border-radius: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
    </style>
</head>
<body>

    <div id="feedback-overlay"></div>
    <div id="fox-toast">ğŸ¦Š ì—¬ìš°ê°€ ë‚˜íƒ€ë‚¬ë‹¤!</div>

    <div id="header">
        <div style="font-size: 22px;">ğŸŒ² ë™ë¬¼ ìˆ²ì˜ ìˆ˜í•™ ì—°ê¸ˆìˆ ì‚¬</div>
        <div class="score-box">ğŸ° ë‚˜: <span id="p-score" style="color:#00796b;">0</span>ì  vs ğŸ¦Š ì—¬ìš°: <span id="f-score" style="color:#c62828;">0</span>ì </div>
        <div style="font-size: 18px; color: #555;">Turn <span id="turn-cnt">1</span></div>
    </div>
    
    <div id="game-board"></div>

    <div id="control-panel">
        <div id="m-display">ğŸ”¥ ë¶ˆê½ƒ: <span id="cnt-fire">0</span><br>â„ï¸ ì–¼ìŒ: <span id="cnt-ice">0</span><br>ğŸŒ¿ ì•½ì´ˆ: <span id="cnt-herb">0</span></div>
        
        <div style="display:flex; gap:15px; align-items: center;">
            <div id="inventory">
                <div class="inv-slot" onclick="handleItemClick(0)"></div>
                <div class="inv-slot" onclick="handleItemClick(1)"></div>
                <div class="inv-slot" onclick="handleItemClick(2)"></div>
            </div>
            
            <div id="ice-pouch" onclick="useIcePotion()">
                <div style="font-size:32px;">â„ï¸</div>
                <div class="ice-count" id="ice-count-text">0 / 2</div>
            </div>
        </div>

        <div class="btn-group">
            <button id="btn-gather" class="btn-orange" onclick="openGatherModal()">ğŸŒ¿ ì¬ë£Œ ì±„ì§‘</button>
            <button id="btn-craft" class="btn-green" onclick="openCraftModal()">âš—ï¸ ë¬¼ì•½ ì œì‘</button>
        </div>
    </div>

    <button id="collection-btn" onclick="openCollection()">ğŸ“š ë‚´ ìˆ˜ì§‘í’ˆ ë³´ê¸°</button>

    <div class="overlay" id="overlay"></div>

    <div class="modal" id="gather-modal">
        <h3>ğŸ“ ì–´ë””ë¡œ ê°ˆê¹Œìš”?</h3>
        <p style="color:#666; font-size:14px; margin-bottom:15px;">(âš ï¸ ì§€ì—­ í•œ ê³³ì´ ë´‰ì‡„ë˜ì—ˆìŠµë‹ˆë‹¤)</p>
        <div style="display:flex; gap:10px; justify-content: center;">
            <button id="loc-fire" onclick="startMath('fire')" style="background:#ffccbc; width:100px; height:100px;">ğŸ”¥ í™”ì‚°<br><span style="font-size:12px;">(ê³±ì…ˆ)</span></button>
            <button id="loc-ice" onclick="startMath('ice')" style="background:#b3e5fc; width:100px; height:100px;">â„ï¸ ë™êµ´<br><span style="font-size:12px;">(ë‚˜ëˆ—ì…ˆ)</span></button>
            <button id="loc-herb" onclick="startMath('herb')" style="background:#c8e6c9; width:100px; height:100px;">ğŸŒ¿ ìˆ²<br><span style="font-size:12px;">(ì‹¬í™”)</span></button>
        </div>
        <button onclick="closeAll()" style="margin-top:20px; background:#ddd;">ì·¨ì†Œ</button>
    </div>

    <div class="modal" id="craft-modal">
        <h3>âš—ï¸ ë§ˆë²• ì‹¤í—˜ì‹¤</h3>
        <p style="color:#666; font-size:14px;">(ğŸ› ï¸ ë„êµ¬ í•˜ë‚˜ê°€ ê³ ì¥ë‚˜ì„œ ìˆ˜ë¦¬ì¤‘ì…ë‹ˆë‹¤)</p>
        <div id="recipe-list" style="text-align:left; margin: 10px 0;"></div>
        <button onclick="closeAll()" style="margin-top:15px; background:#ddd;">ë‹«ê¸°</button>
    </div>

    <div class="modal" id="math-modal">
        <h2 id="q-text" style="font-size:32px; margin-bottom: 20px; color:#333;"></h2>
        <div id="timer-bar" style="height:5px; background:#eee; width:100%; margin-bottom:15px;"><div id="timer-fill" style="height:100%; background:#ff9800; width:100%; transition:width 1s linear;"></div></div>
        
        <div id="input-single" style="display:none;"><input type="number" id="ans-single" placeholder="ì •ë‹µ"></div>
        <div id="input-frac" class="fraction-box" style="display:none;"><input type="number" id="ans-num" placeholder="ë¶„ì"><div class="frac-line"></div><input type="number" id="ans-den" placeholder="ë¶„ëª¨"></div>
        <div id="input-mixed" class="mixed-box" style="display:none;"><input type="number" id="ans-mixed-w" class="whole-num-input" placeholder="ìì—°ìˆ˜"><div class="fraction-box"><input type="number" id="ans-mixed-n" placeholder="ë¶„ì"><div class="frac-line" style="width:70px;"></div><input type="number" id="ans-mixed-d" placeholder="ë¶„ëª¨"></div></div>

        <button onclick="submitAnswer()" class="btn-green" style="width:100%; margin-top:20px; padding:15px;">âœ¨ ì •ë‹µ í™•ì¸!</button>
    </div>

    <div class="modal" id="result-modal">
        <h3 id="result-title">ğŸ‰ ì•„ì´í…œ íšë“!</h3>
        <div id="result-content"></div>
        <button onclick="closeResult()" class="btn-green" style="margin-top:15px;">í™•ì¸</button>
    </div>

    <script>
        const SYLVANIAN_DB = {
            tier5: ["ğŸ  ë¹¨ê°„ ì§€ë¶• ì´ì¸µì§‘", "ğŸ’¡ ë¶ˆì´ ë“¤ì–´ì˜¤ëŠ” 2ì¸µì§‘", "ğŸ° ìºìŠ¬ ìœ ì¹˜ì›", "ğŸš² í•˜ëŠ˜ì„ ë‚˜ëŠ” ìì „ê±°", "ğŸ›ï¸ ì—˜ë ˆê°•ìŠ¤ íƒ€ìš´ ë§ˆë„ˆ", "ğŸ¬ ê·¸ëœë“œ ë°±í™”ì ", "ğŸš¢ ì”¨ì‚¬ì´ë“œ í¬ë£¨ì¦ˆ", "ğŸ˜ï¸ 3ì¸µì§‘ ê¸°í”„íŠ¸ ì„¸íŠ¸", "ğŸ•ï¸ ë¹„ë°€ì˜ ìˆ² ì˜¤ë‘ë§‰", "ğŸ  ìœ ì›ì§€ ë¡œì—´ ë§ˆì°¨"],
            tier3: ["ğŸ° ì´ˆì½œë¦¿ í† ë¼ ê°€ì¡±", "ğŸ¿ï¸ í˜¸ë‘ë‹¤ëŒì¥ ê°€ì¡±", "ğŸš íŒ¨ë°€ë¦¬ ìº í•‘ì¹´", "ğŸšŒ ìœ ì¹˜ì› ë²„ìŠ¤", "ğŸ³ ì£¼ë°© ìš”ë¦¬ ì„¸íŠ¸", "ğŸ©º ì‹œê³¨ ë³‘ì› ì„ ìƒë‹˜", "ğŸŒ² ëª¨í—˜ê°€ì˜ íŠ¸ë¦¬í•˜ìš°ìŠ¤", "ğŸ›’ ìˆ²ì†ì˜ ë§ˆì¼“", "ğŸ›‹ï¸ ê±°ì‹¤ ì†ŒíŒŒ ì„¸íŠ¸", "ğŸ› ì•¤í‹°í¬ ìš•ì‹¤ ì„¸íŠ¸"],
            tier1: ["ğŸ± ì•„ê¸° í˜ë¥´ì‹œì•ˆ", "ğŸ° ì•„ê¸° ë°€í¬ í† ë¼", "ğŸ‘¶ ìŒë‘¥ì´ ì´ˆì½œë¦¿ í† ë¼", "ğŸ’ ìœ ì¹˜ì› ëª¨ìì™€ ê°€ë°©", "ğŸ± í”¼í¬ë‹‰ ë„ì‹œë½", "ğŸ» ë¯¸ë‹ˆ ë°”ì´ì˜¬ë¦°", "ğŸš² ì„¸ë°œ ìì „ê±°", "ğŸ›ï¸ ì•„ê¸° ì¹¨ëŒ€", "ğŸ° ë”¸ê¸° ì¼€ì´í¬", "ğŸ›’ ì¥ë‚œê° ìœ ëª¨ì°¨"]
        };
        const POTIONS = {
            red: { name: 'ìš©ê¸°ë¬¼ì•½', icon: 'ğŸ”´', cost: { fire: 1 } },
            blue: { name: 'ì§€í˜œë¬¼ì•½', icon: 'ğŸ”µ', cost: { ice: 1 } },
            green: { name: 'ìƒëª…ë¬¼ì•½', icon: 'ğŸŸ¢', cost: { herb: 1 } },
            purple: { name: 'ì—˜ë¦­ì„œ', icon: 'ğŸŸ£', cost: { fire: 1, ice: 1, herb: 1 } }
        };
        
        const BLOCK_MSGS = {
            loc: { fire: "ğŸŒ‹ í™”ì‚°ì´ ë¶€ê¸€ê±°ë ¤ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!", ice: "â„ï¸ ëˆˆë³´ë¼ ë•Œë¬¸ì— ë™êµ´ ì…êµ¬ê°€ ì–¼ì—ˆìŠµë‹ˆë‹¤!", herb: "ğŸ» ìˆ²ì— ë°°ê³ í”ˆ ê³°ì´ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!" },
            pot: { red: "ğŸ”¥ ìš©ê¸°ì˜ ì†¥ì´ ë„ˆë¬´ ëœ¨ê±°ì›Œ ì‹íˆê³  ìˆìŠµë‹ˆë‹¤.", blue: "ğŸ§Š ì§€í˜œì˜ ì¦ë¥˜ê´€ì´ ì–¼ì–´ë¶™ì–´ ë…¹ì´ê³  ìˆìŠµë‹ˆë‹¤.", green: "ğŸŒ¿ ì•½ì´ˆ ë¹»ëŠ” ì ˆêµ¬ê°€ ë¶€ì„œì ¸ ìˆ˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.", purple: "âš ï¸ ì—˜ë¦­ì„œ ë°°í•© ê¸°ê³„ê°€ ì˜¤ì‘ë™ì„ ì¼ìœ¼ì¼°ìŠµë‹ˆë‹¤." }
        };

        const state = {
            turn: 1, pScore: 0, fScore: 0, mat: { fire: 0, ice: 0, herb: 0 }, 
            inv: [null, null, null], icePotions: 0, usedIceTurn: false, isFoxFrozen: false,
            treasures: [], foxTarget: null, blockedLoc: null, blockedPot: null, 
            collection: [], curProb: null, startTime: 0
        };

        window.onload = init;
        function init() {
            const configs = [
                {rank:'gold', pts:5, icon:'ğŸ†', turns:7}, {rank:'gold', pts:5, icon:'ğŸ†', turns:7},
                {rank:'silver', pts:3, icon:'ğŸ¥ˆ', turns:5}, {rank:'silver', pts:3, icon:'ğŸ¥ˆ', turns:5}, {rank:'silver', pts:3, icon:'ğŸ¥ˆ', turns:5},
                {rank:'wood', pts:1, icon:'ğŸ“¦', turns:4}, {rank:'wood', pts:1, icon:'ğŸ“¦', turns:4}, {rank:'wood', pts:1, icon:'ğŸ“¦', turns:4}, {rank:'wood', pts:1, icon:'ğŸ“¦', turns:4}, {rank:'wood', pts:1, icon:'ğŸ“¦', turns:4}
            ].sort(() => Math.random() - 0.5);
            state.treasures = configs.map((cfg, i) => {
                const basics = ['red', 'blue', 'green'];
                let req = cfg.rank==='wood' ? [basics[Math.floor(Math.random()*3)]] : cfg.rank==='silver' ? [...basics].sort(()=>Math.random()-0.5).slice(0, 2) : ['purple', basics[Math.floor(Math.random()*3)]];
                return { ...cfg, id: i, prog: 0, status: 'alive', req };
            });
            startNewTurn();
        }

        function startNewTurn() {
            const locs = ['fire', 'ice', 'herb']; state.blockedLoc = locs[Math.floor(Math.random() * locs.length)];
            const pots = ['red', 'blue', 'green', 'purple']; state.blockedPot = pots[Math.floor(Math.random() * pots.length)];
            state.usedIceTurn = false; // í„´ ì‹œì‘ì‹œ ì´ˆê¸°í™”
            showToast(`Turn ${state.turn} ì•Œë¦¼ ğŸ“¢\n\nâ›” ${BLOCK_MSGS.loc[state.blockedLoc]}\nğŸ› ï¸ ${BLOCK_MSGS.pot[state.blockedPot]}`);
            render();
        }

        function useIcePotion() {
            if (state.icePotions <= 0) return;
            if (state.usedIceTurn) { alert("ğŸš« ì´ë²ˆ í„´ì—ëŠ” ì´ë¯¸ ì–¼ìŒ í¬ì…˜ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤!"); return; }
            if (confirm("â„ï¸ ì–¼ìŒ í¬ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì—¬ìš°ë¥¼ í•œ í„´ ë©ˆì¶”ê²Œ í• ê¹Œìš”?")) {
                state.icePotions--; state.isFoxFrozen = true; state.usedIceTurn = true;
                showFeedback(true, "ì—¬ìš°ê°€ ê½ê½ ì–¼ì—ˆìŠµë‹ˆë‹¤! ğŸ¥¶"); render();
            }
        }

        function handleItemClick(idx) {
            const item = state.inv[idx];
            if (item && confirm(`ì´ ${POTIONS[item].name}ì„ ë²„ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                state.inv[idx] = null; render();
            }
        }

        const MathEngine = {
            rnd(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; },
            mkFrac(w, n, d) { return `${w > 0 ? w : ''}<span style="display:inline-block; vertical-align:middle; text-align:center; font-size:0.8em; margin-left:5px;"><span style="display:block; border-bottom:2px solid #333;">${n}</span><span>${d}</span></span>`; },
            get(type) {
                let q, a, mode = 'single';
                if (type === 'fire') {
                    let n1 = this.rnd(100, 500), maxN2 = Math.floor(10000/n1); if(maxN2<10){n1=this.rnd(100,200);maxN2=Math.floor(10000/n1);} let n2=this.rnd(10,Math.min(99,maxN2)); q=`${n1} Ã— ${n2} = ?`; a=n1*n2;
                } else if (type === 'ice') {
                    let quo=this.rnd(11,50), div=this.rnd(Math.max(10,Math.ceil(1000/quo)),99); q=`${quo*div} Ã· ${div} = ?`; a=quo;
                } else if (type === 'herb') {
                    if(Math.random()<0.5){ let n1=this.rnd(102,999), n2=this.rnd(Math.max(10,Math.ceil(10000/n1)),99); q=`${n1} Ã— ${n2} = ?`; a=n1*n2; }
                    else{ let quo=this.rnd(50,200), div=this.rnd(Math.max(10,Math.ceil(1000/quo)),99); q=`${quo*div} Ã· ${div} = ?`; a=quo; }
                } else if (['red','blue','green','purple'].includes(type)) {
                    let d1=this.rnd(2,9), d2=this.rnd(2,9); if(d1===d2) d2=(d1%8)+2; let n1=this.rnd(1,d1-1), n2=this.rnd(1,d2-1);
                    if(type==='red'){ q=`${this.mkFrac(0,n1,d1)} + ${this.mkFrac(0,n2,d2)} = ?`; a={w:0,n:n1*d2+n2*d1,d:d1*d2}; mode='frac'; }
                    else if(type==='blue'){ let v1=n1/d1,v2=n2/d2; if(v1<v2){[n1,n2]=[n2,n1];[d1,d2]=[d2,d1];} q=`${this.mkFrac(0,n1,d1)} - ${this.mkFrac(0,n2,d2)} = ?`; a={w:0,n:n1*d2-n2*d1,d:d1*d2}; mode='frac'; }
                    else { let w1=this.rnd(1,3), w2=this.rnd(1,3), plus=Math.random()<0.5; if(!plus){ let v1=w1+n1/d1,v2=w2+n2/d2; if(v1<v2){[w1,w2]=[w2,w1];[n1,n2]=[n2,n1];[d1,d2]=[d2,d1];} }
                        q=`${this.mkFrac(w1,n1,d1)} ${plus?'+':'-'} ${this.mkFrac(w2,n2,d2)} = ?`; 
                        let num = plus ? ((w1*d1+n1)*d2 + (w2*d2+n2)*d1) : ((w1*d1+n1)*d2 - (w2*d2+n2)*d1), den=d1*d2;
                        a={w:Math.floor(num/den), n:num%den, d:den}; if(a.n===0){a=a.w; mode='single';} else mode='mixed';
                    }
                } 
                // [FIXED] Equation logic sync
                else if (type === 'wood') { 
                    let x=this.rnd(2,9), A=this.rnd(2,9), B=this.rnd(1,20); 
                    let isPlus = Math.random() < 0.5;
                    let res = isPlus ? A*x+B : A*x-B;
                    q=`${A}x ${isPlus?'+':'-'} ${B} = ${res}`; a=x;
                } else if (type === 'silver') { 
                    let x=this.rnd(2,9), A=this.rnd(2,9), C=this.rnd(3,9);
                    let B=this.rnd(1,10);
                    // Ax - B = Cx - (Cx - (Ax - B)) 
                    let rhs = C*x - (A*x - B);
                    q=`${A}x - ${B} = ${C}x - ${rhs}`; a=x;
                } else if (type === 'gold') { 
                    let x=this.rnd(2,9), A=this.rnd(2,5), B=this.rnd(1,5);
                    if(Math.random()<0.5) { q=`${A}(x + ${B}) = ${A*(x+B)}`; }
                    else { x=B+this.rnd(1,9); q=`${A}(x - ${B}) = ${A*(x-B)}`; }
                    a=x;
                }
                return { q, a, type, mode };
            }
        };

        function openGatherModal() {
            document.getElementById('overlay').style.display='block'; document.getElementById('gather-modal').style.display='block';
            ['fire','ice','herb'].forEach(t=>{ const btn=document.getElementById(`loc-${t}`); if(state.blockedLoc===t){btn.classList.add('btn-disabled');btn.disabled=true;}else{btn.classList.remove('btn-disabled');btn.disabled=false;} });
        }
        function openCraftModal() {
            document.getElementById('overlay').style.display='block'; document.getElementById('craft-modal').style.display='block';
            const list=document.getElementById('recipe-list'); list.innerHTML='';
            Object.entries(POTIONS).forEach(([key, p]) => {
                let canCraft = Object.entries(p.cost).every(([m, c]) => state.mat[m] >= c);
                if(!state.inv.includes(null)) canCraft=false; let isBlocked=(state.blockedPot===key);
                let costStr=[]; Object.entries(p.cost).forEach(([m,c])=>{costStr.push(`${m==='fire'?'ğŸ”¥':m==='ice'?'â„ï¸':'ğŸŒ¿'}${c}`)});
                list.innerHTML+=`<div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee;opacity:${(canCraft&&!isBlocked)?1:0.5}"><div><span style="font-size:24px;">${p.icon}</span> ${p.name} <small>(${costStr.join(' ')})</small></div><button class="btn-green ${isBlocked?'btn-disabled':''}" onclick="startMath('${key}')" ${(canCraft&&!isBlocked)?'':'disabled'}>${isBlocked?'ìˆ˜ë¦¬ì¤‘':'ì œì‘'}</button></div>`;
            });
        }
        function startMath(type, targetId=null) {
            closeAll(); const prob=MathEngine.get(type); state.curProb={...prob, targetId};
            document.getElementById('q-text').innerHTML=`Q. ${prob.q}`;
            document.getElementById('overlay').style.display='block'; document.getElementById('math-modal').style.display='block';
            document.getElementById('input-single').style.display='none'; document.getElementById('input-frac').style.display='none'; document.getElementById('input-mixed').style.display='none';
            document.querySelectorAll('input').forEach(i=>i.value='');
            if(prob.mode==='mixed') document.getElementById('input-mixed').style.display='flex'; else if(prob.mode==='frac') document.getElementById('input-frac').style.display='flex'; else document.getElementById('input-single').style.display='block';
            state.startTime=Date.now(); const limit=(['herb','purple','gold'].includes(type))?30:15;
            const bar=document.getElementById('timer-fill'); bar.style.transition='none'; bar.style.width='100%'; setTimeout(()=>{bar.style.transition=`width ${limit}s linear`;bar.style.width='0%';},50);
        }

        function submitAnswer() {
            const prob=state.curProb, elapsed=(Date.now()-state.startTime)/1000; let correct=false;
            if(prob.mode==='mixed'){ const w=parseInt(document.getElementById('ans-mixed-w').value)||0, n=parseInt(document.getElementById('ans-mixed-n').value)||0, d=parseInt(document.getElementById('ans-mixed-d').value)||1; if(Math.abs((w+n/d)-(prob.a.w+prob.a.n/prob.a.d))<0.001) correct=true; }
            else if(prob.mode==='frac'){ const n=parseInt(document.getElementById('ans-num').value), d=parseInt(document.getElementById('ans-den').value); if(Math.abs((n/d)-(prob.a.n/prob.a.d))<0.001) correct=true; }
            else { if(parseInt(document.getElementById('ans-single').value)===prob.a) correct=true; }

            closeAll();
            if(correct) {
                const limit=(['herb','purple','gold'].includes(prob.type))?30:15, isSpeed=elapsed<=limit;
                if(['fire','ice','herb'].includes(prob.type)) {
                    let amount=1, msg="ì¬ë£Œ íšë“! +1"; if(isSpeed){amount=2;msg="âš¡ìŠ¤í”¼ë“œ ë³´ë„ˆìŠ¤! ì¬ë£Œ x2";}
                    state.mat[prob.type]+=amount; showFeedback(true, msg);
                } 
                else if(POTIONS[prob.type]) {
                    Object.entries(POTIONS[prob.type].cost).forEach(([m,c])=>state.mat[m]-=c);
                    let msg="í¬ì…˜ ì™„ì„±! âš—ï¸";
                    let idx = state.inv.indexOf(null); if(idx>-1) state.inv[idx]=prob.type;
                    if(isSpeed) {
                        if(state.icePotions < 2) { state.icePotions++; msg = "âš¡ìŠ¤í”¼ë“œ ë³´ë„ˆìŠ¤! ì–¼ìŒ í¬ì…˜ íšë“! â„ï¸"; } 
                        else { msg = "âš¡ìŠ¤í”¼ë“œ ë³´ë„ˆìŠ¤! (ì–¼ìŒ ì£¼ë¨¸ë‹ˆ ê½‰ì°¸)"; }
                    }
                    showFeedback(true, msg);
                } 
                else {
                    const t=state.treasures[prob.targetId]; t.req.forEach(r=>{state.inv[state.inv.indexOf(r)]=null;});
                    t.status='player'; 
                    const reward=drawGacha(t.rank, isSpeed); state.pScore+=reward.pts; state.collection.push(reward);
                    if(isSpeed) showFeedback(true, "âš¡ìŠ¤í”¼ë“œ ë³´ë„ˆìŠ¤! í™•ë¥  UP!"); showResultModal(reward, t.rank);
                }
            } else showFeedback(false, "ê³„ì‚° ì‹¤ìˆ˜... í„´ ì¢…ë£Œ ğŸ˜“");
            foxTurn();
        }

        function drawGacha(rank, isSpeed) {
            const r=Math.floor(Math.random()*100)+1; let tier='tier1', pts=1;
            if(isSpeed) {
                if(rank==='gold'){tier='tier5';pts=5;} else if(rank==='silver'){if(r<=30){tier='tier5';pts=5;}else{tier='tier3';pts=3;}} else{if(r<=15){tier='tier5';pts=5;}else if(r<=50){tier='tier3';pts=3;}else{tier='tier1';pts=1;}}
            } else {
                if(rank==='gold'){if(r<=70){tier='tier5';pts=5;}else{tier='tier3';pts=3;}} else if(rank==='silver'){if(r<=20){tier='tier5';pts=5;}else if(r<=70){tier='tier3';pts=3;}} else{if(r<=10){tier='tier5';pts=5;}else if(r<=30){tier='tier3';pts=3;}}
            }
            const list=SYLVANIAN_DB[tier], name=list[Math.floor(Math.random()*list.length)]; return {name, pts, tier};
        }

        function foxTurn() {
            if(state.isFoxFrozen) {
                showFeedback(true, "ì—¬ìš°ê°€ ê½ê½ ì–¼ì–´ ì›€ì§ì´ì§€ ëª»í•©ë‹ˆë‹¤! â„ï¸");
                state.isFoxFrozen = false; state.turn++; startNewTurn(); return;
            }
            const alive=state.treasures.filter(t=>t.status==='alive');
            if(alive.length>0) {
                if(state.foxTarget===null || state.treasures[state.foxTarget].status!=='alive') state.foxTarget=alive[Math.floor(Math.random()*alive.length)].id;
                const t=state.treasures[state.foxTarget];
                
                const diff = state.pScore - state.fScore;
                let scoreChance = 0; if(diff>=5) scoreChance=1.0; else if(diff===4) scoreChance=0.75; else if(diff===3) scoreChance=0.5; else if(diff===2) scoreChance=0.25;
                let turnChance = 0; if(state.turn >= 20) turnChance = 0.75; else if(state.turn >= 15) turnChance = 0.50; else if(state.turn >= 10) turnChance = 0.25;
                let totalChance = Math.min(1.0, scoreChance + turnChance);

                let move=1, msg="ğŸ¦Š ì—¬ìš°ê°€ ì‚´ê¸ˆì‚´ê¸ˆ ë‹¤ê°€ì˜µë‹ˆë‹¤...";
                if(Math.random() < totalChance) { move=2; msg="ğŸš€ ì—¬ìš°ê°€ ì „ë ¥ì§ˆì£¼í•©ë‹ˆë‹¤! (2ì¹¸ ì´ë™)"; }
                
                t.prog+=move; showToast(msg);
                if(t.prog>=t.turns) {
                    t.status='fox'; state.foxTarget=null;
                    const reward=drawGacha(t.rank, false); state.fScore+=reward.pts;
                    showFeedback(false, `ì—¬ìš°ê°€ ${reward.name} íšë“!`);
                }
            }
            if(state.treasures.every(t=>t.status!=='alive')) {
                setTimeout(()=>{alert(`ê²Œì„ ì¢…ë£Œ!\në‚˜: ${state.pScore} vs ì—¬ìš°: ${state.fScore}`);},500); return;
            }
            state.turn++; startNewTurn();
        }

        function showResultModal(item, rank) {
            const bg=item.tier==='tier5'?'#fff9c4':item.tier==='tier3'?'#e1f5fe':'#f5f5f5', bd=item.tier==='tier5'?'gold':item.tier==='tier3'?'silver':'#ddd';
            document.getElementById('result-content').innerHTML=`<div class="item-card" style="background:${bg};border-color:${bd}"><div style="font-size:40px;">ğŸ</div><div style="font-size:18px;font-weight:bold;color:#ef6c00;margin:10px 0;">${item.name}</div><div style="font-size:14px;color:#777;">ê°€ì¹˜: ${item.pts}ì </div></div>`;
            document.getElementById('overlay').style.display='block'; document.getElementById('result-modal').style.display='block';
        }
        function openCollection() {
            const c=document.getElementById('result-content'); document.getElementById('result-title').innerText="ğŸ“š ë‚´ ìˆ˜ì§‘í’ˆ ë„ê°";
            c.innerHTML=state.collection.length===0?"<p>ì•„ì§ ëª¨ì€ ì•„ì´í…œì´ ì—†ì–´ìš”!</p>":`<div style="max-height:300px;overflow-y:auto;">${state.collection.map(i=>`<div style="padding:5px;border-bottom:1px solid #eee;">${i.name} (${i.pts}ì )</div>`).join('')}</div>`;
            document.getElementById('overlay').style.display='block'; document.getElementById('result-modal').style.display='block';
        }
        function tryAdventure(id) { const t=state.treasures[id]; if(t.status!=='alive')return; if(!t.req.every(r=>state.inv.includes(r))){showToast("âš ï¸ í•„ìš”í•œ ë¬¼ì•½ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!");return;} startMath(t.rank, id); }
        function removeItem(i) { if(state.inv[i]&&confirm("ì´ ë¬¼ì•½ì„ ë²„ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?")){state.inv[i]=null;render();} }
        function render() {
            document.getElementById('p-score').innerText=state.pScore; document.getElementById('f-score').innerText=state.fScore; document.getElementById('turn-cnt').innerText=state.turn;
            document.getElementById('cnt-fire').innerText=state.mat.fire; document.getElementById('cnt-ice').innerText=state.mat.ice; document.getElementById('cnt-herb').innerText=state.mat.herb;
            state.inv.forEach((item,i)=>{ const el=document.getElementById('inventory').children[i]; el.innerHTML=item?POTIONS[item].icon:''; el.className=`inv-slot ${item?'filled':''}`; });
            
            const icePouch = document.getElementById('ice-pouch'); const iceCountText = document.getElementById('ice-count-text');
            iceCountText.innerText = `${state.icePotions} / 2`;
            if(state.icePotions > 0 && !state.usedIceTurn) { icePouch.classList.remove('disabled'); } else { icePouch.classList.add('disabled'); }

            const board=document.getElementById('game-board'); board.innerHTML='';
            state.treasures.forEach(t=>{
                const box=document.createElement('div'); box.className='slot-box';
                if(t.status==='alive'){
                    const per=(t.prog/t.turns)*100; if(per>=75)box.classList.add('warning-high'); else if(per>=50)box.classList.add('warning-mid');
                    box.onclick=()=>tryAdventure(t.id); box.innerHTML=`<div class="treasure-icon">${t.icon}</div><div class="req-icons">${t.req.map(r=>POTIONS[r].icon).join(' ')}</div>`;
                } else { box.style.background='#eee'; box.style.cursor='default'; box.innerHTML=`<div style="font-size:40px;">${t.status==='player'?'ğŸ°':'ğŸ¦Š'}</div>`; }
                board.appendChild(box);
            });
        }
        function showFeedback(s,t){const el=document.getElementById('feedback-overlay');el.innerText=t;el.className=s?'success-anim':'fail-anim';setTimeout(()=>{el.className='';},1500);}
        function showToast(m){const t=document.getElementById('fox-toast');t.innerText=m;t.style.display='block';setTimeout(()=>{t.style.display='none';},3500);}
        function closeAll(){document.querySelectorAll('.modal').forEach(m=>m.style.display='none');document.getElementById('overlay').style.display='none';}
        function closeResult(){closeAll();}
    </script>
</body>
</html>