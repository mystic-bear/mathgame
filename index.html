<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë™ë¬¼ ìˆ²ì˜ ìˆ˜í•™ ì—°ê¸ˆìˆ ì‚¬ - Final Ver.</title>
    <style>
        :root { --primary: #4db6ac; --bg: #f0f4f8; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; user-select: none; }
        
        #game-board { 
            display: grid; grid-template-columns: repeat(5, 140px); grid-template-rows: repeat(2, 160px); 
            gap: 15px; background: white; padding: 20px; border-radius: 20px; border: 4px solid #81c784; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-top: 10px;
        }
        .slot-box { border: 2px solid #eee; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fafafa; position: relative; }
        .treasure-item { font-size: 50px; cursor: pointer; transition: 0.2s; }
        .treasure-item:hover { transform: scale(1.1); }
        .req-hint { font-size: 16px; margin-top: 5px; letter-spacing: 2px; }

        .warning-mid { box-shadow: inset 0 0 15px #fff176; border-color: #fdd835; }
        .warning-high { box-shadow: inset 0 0 20px #e57373; border-color: #f44336; animation: shake 0.5s infinite; }
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-2px, 2px); } 75% { transform: translate(2px, -2px); } }

        #fox-toast {
            display: none; position: fixed; top: 12%; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85); color: white; padding: 12px 25px; border-radius: 50px;
            font-size: 16px; font-weight: bold; z-index: 2000; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        #control-panel { width: 760px; height: 120px; background: white; margin-top: 20px; border-radius: 15px; display: flex; justify-content: space-around; align-items: center; border: 2px solid #81c784; }
        .inv-slot { width: 52px; height: 52px; border: 2px dashed #ccc; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 26px; cursor: pointer; }
        .inv-slot.filled { border-style: solid; border-color: var(--primary); background: #e0f2f1; }

        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 25px; z-index: 100; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.2); min-width: 380px; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 99; backdrop-filter: blur(2px); }
        
        .fraction-area { display: none; flex-direction: column; align-items: center; gap: 5px; } 
        
        .mixed-input-area { 
            display: none;
            flex-direction: row; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
        }
        .mixed-whole-input { width: 60px; height: 60px; font-size: 24px; text-align: center; border: 2px solid #ccc; border-radius: 8px; }
        .mixed-frac-part { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .mixed-frac-input { width: 50px; font-size: 20px; text-align: center; border: 2px solid #ccc; border-radius: 5px; padding: 5px; }

        .line { width: 60px; height: 3px; background: #333; }
        input { font-size: 24px; width: 100px; text-align: center; padding: 8px; border: 2px solid #ccc; border-radius: 8px; }
        button { padding: 10px 20px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-main { background: var(--primary); color: white; }
        
        .mixed-fraction { display: inline-flex; align-items: center; vertical-align: middle; margin: 0 5px; }
        .whole-num { font-size: 1.4em; margin-right: 5px; font-weight: bold; }
        .frac { display: flex; flex-direction: column; align-items: center; font-size: 0.9em; }
        .frac-top { border-bottom: 2px solid #333; padding: 0 4px; display: block; width: 100%; text-align: center; }
        .frac-bottom { padding: 0 4px; display: block; width: 100%; text-align: center; }
    </style>
</head>
<body>

    <div id="fox-toast">ğŸ¦Š ë¬´ì–¸ê°€ë¥¼ ë…¸ë¦¬ê³  ìˆë‹¤...</div>

    <div style="margin-bottom:15px; font-weight:bold; color: #2e7d32; font-size: 20px;">
        ğŸŒ² ìˆ˜í•™ ì—°ê¸ˆìˆ ì‚¬ | ì ìˆ˜: ğŸ° <span id="p-score">0</span> : ğŸ¦Š <span id="f-score">0</span> | í„´: <span id="turn">1</span>
    </div>
    
    <div id="game-board"></div>

    <div id="control-panel">
        <div id="m-display" style="font-size:14px; background:#f1f8e9; padding:10px; border-radius:10px;">ğŸ”¥ 0 | â„ï¸ 0 | ğŸŒ¿ 0</div>
        <div style="display:flex; gap:8px;" id="inventory">
            <div class="inv-slot" onclick="removeItem(0)"></div>
            <div class="inv-slot" onclick="removeItem(1)"></div>
            <div class="inv-slot" onclick="removeItem(2)"></div>
            <div class="inv-slot" onclick="removeItem(3)"></div>
            <div class="inv-slot" onclick="removeItem(4)"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-main" onclick="openModal('gather')">ğŸŒ¿ ì±„ì§‘í•˜ê¸°</button>
            <button class="btn-main" style="background:#81c784;" onclick="openModal('craft')">âš—ï¸ ì œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <div class="modal" id="gather-modal">
        <h3>ğŸŒ¿ ì–´ë””ë¡œ ì±„ì§‘í•˜ëŸ¬ ê°ˆê¹Œìš”?</h3>
        <div style="display:flex; gap:15px; margin:20px 0;">
            <div onclick="startMath('fire')" style="border:2px solid #ff7043; padding:15px; border-radius:15px; cursor:pointer; flex:1">ğŸ”¥ í™”ì‚°<br><small>ê³±ì…ˆ</small></div>
            <div onclick="startMath('ice')" style="border:2px solid #4fc3f7; padding:15px; border-radius:15px; cursor:pointer; flex:1">â„ï¸ ë™êµ´<br><small>ë‚˜ëˆ—ì…ˆ</small></div>
            <div onclick="startMath('herb')" style="border:2px solid #66bb6a; padding:15px; border-radius:15px; cursor:pointer; flex:1">ğŸŒ¿ ìˆ²<br><small>ì‹¬í™”</small></div>
        </div>
        <button onclick="closeAll()" style="background:#ccc; color:#333; margin-top:10px;">ì·¨ì†Œ</button>
    </div>

    <div class="modal" id="craft-modal">
        <h3>âš—ï¸ ë§ˆë²• ì‹¤í—˜ì‹¤</h3>
        <div id="recipe-container"></div>
        <button onclick="closeAll()" style="margin-top:15px; background:#f5f5f5; color:#333;">ë‹«ê¸°</button>
    </div>

    <div class="modal" id="math-modal">
        <h2 id="question-text" style="font-size:32px; margin-bottom: 20px;"></h2>
        
        <div id="input-normal"><input type="number" id="ans-single"></div>
        
        <div id="input-fraction" class="fraction-area">
            <input type="number" id="ans-num" placeholder="ë¶„ì">
            <div class="line"></div>
            <input type="number" id="ans-den" placeholder="ë¶„ëª¨">
        </div>

        <div id="input-mixed" class="mixed-input-area">
            <input type="number" id="ans-mixed-whole" class="mixed-whole-input" placeholder="ì •ìˆ˜">
            <div class="mixed-frac-part">
                <input type="number" id="ans-mixed-num" class="mixed-frac-input" placeholder="ë¶„ì">
                <div class="line" style="width:50px; height:2px;"></div>
                <input type="number" id="ans-mixed-den" class="mixed-frac-input" placeholder="ë¶„ëª¨">
            </div>
        </div>

        <button onclick="submitAnswer()" class="btn-main" style="width:100%; margin-top:20px; padding:15px;">ì •ë‹µ í™•ì¸</button>
    </div>

    <script>
        window.onload = function() {
            init();
        };

        const POTIONS = {
            red: { name: 'ìš©ê¸°', icon: 'ğŸ”´', req: { fire: 1 } },
            blue: { name: 'ì§€í˜œ', icon: 'ğŸ”µ', req: { ice: 1 } },
            green: { name: 'ìƒëª…', icon: 'ğŸŸ¢', req: { herb: 1 } },
            purple: { name: 'ì—˜ë¦­ì„œ', icon: 'ğŸŸ£', req: { fire: 1, ice: 1, herb: 1 } }
        };

        const state = {
            turn: 1, pScore: 0, fScore: 0,
            materials: { fire: 0, ice: 0, herb: 0 },
            inv: [null, null, null, null, null],
            treasures: [], curProb: null, foxTargetId: null
        };

        function showFoxSpeech(text) {
            const toast = document.getElementById('fox-toast');
            toast.innerText = `ğŸ¦Š ${text}`;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        }

        const MathEngine = {
            rnd(m, n) { return Math.floor(Math.random() * (n - m + 1)) + m; },
            
            makeMixedHtml(w, n, d) {
                return `<div class="mixed-fraction"><span class="whole-num">${w}</span><div class="frac"><span class="frac-top">${n}</span><span class="frac-bottom">${d}</span></div></div>`;
            },

            get(type) {
                let a, b, c, d, x, q, d1, d2, n1, n2, w1, w2;
                switch(type) {
                    // [1. ì±„ì§‘]
                    case 'fire': a = this.rnd(11, 99); b = this.rnd(2, 9); return { q: `${a} Ã— ${b} = ?`, a: a*b };
                    case 'ice': x = this.rnd(11, 50); b = this.rnd(2, 9); return { q: `${x*b} Ã· ${b} = ?`, a: x };
                    case 'herb': {
                        if (Math.random() < 0.5) {
                            b = this.rnd(10, 99);
                            let max_a = Math.floor(9999 / b);
                            if (max_a > 999) max_a = 999;
                            a = this.rnd(100, max_a);
                            return { q: `${a} Ã— ${b} = ?`, a: a*b };
                        } else {
                            let q_val = this.rnd(10, 99);
                            b = this.rnd(10, 99);
                            a = q_val * b;
                            return { q: `${a} Ã· ${b} = ?`, a: q_val };
                        }
                    }
                    
                    // [2. ì œì‘]
                    case 'red': { // ë§ì…ˆ: ë¶„ìë„ ëœë¤ ìƒì„±
                        d1 = this.rnd(2, 5); 
                        d2 = this.rnd(2, 5); 
                        if(d1===d2) d2 = (d1 % 8) + 2;
                        
                        n1 = this.rnd(1, d1 - 1);
                        n2 = this.rnd(1, d2 - 1);
                        
                        let ansN = n1*d2 + n2*d1;
                        let ansD = d1*d2;
                        
                        return { q: `${n1}/${d1} + ${n2}/${d2} = ?`, a: { n: ansN, d: ansD }, isFrac: true };
                    }
                    
                    case 'blue': { // ëº„ì…ˆ: ë¶„ì ëœë¤ ìƒì„± + ì–‘ìˆ˜ ë³´ì¥
                        d1 = this.rnd(2, 9);
                        d2 = this.rnd(2, 9);
                        if(d1===d2) d2 = (d1 % 8) + 2;

                        n1 = this.rnd(1, d1 - 1);
                        n2 = this.rnd(1, d2 - 1);
                        
                        let val1 = n1/d1;
                        let val2 = n2/d2;
                        
                        // ê²°ê³¼ê°€ ìŒìˆ˜ë©´ ìˆœì„œ êµì²´
                        if(val1 < val2) {
                            [n1, n2] = [n2, n1];
                            [d1, d2] = [d2, d1];
                        }
                        
                        let ansN = (n1*d2) - (n2*d1); // í†µë¶„ ê³„ì‚°
                        let ansD = d1*d2;
                        
                        return { q: `${n1}/${d1} - ${n2}/${d2} = ?`, a: { n: ansN, d: ansD }, isFrac: true };
                    }
                    
                    case 'green': {
                        let isPlus = Math.random() < 0.5;
                        let d1 = this.rnd(2, 9);
                        let d2 = this.rnd(2, 9);
                        if(d1 === d2) d2 = (d1 % 8) + 2; 

                        w1 = this.rnd(2, 5); n1 = this.rnd(1, d1 - 1);
                        let val1 = w1 + n1/d1; 
                        
                        w2 = this.rnd(1, w1 - 1); n2 = this.rnd(1, d2 - 1);
                        let val2 = w2 + n2/d2;
                        
                        if (isPlus) {
                            let qHtml = `${this.makeMixedHtml(w1, n1, d1)} + ${this.makeMixedHtml(w2, n2, d2)} = ?`;
                            return { q: qHtml, a: val1 + val2, isHtml: true, isMixed: true };
                        } else {
                            if (val1 < val2) { [w1, w2] = [w2, w1]; [n1, n2] = [n2, n1]; [d1, d2] = [d2, d1]; [val1, val2] = [val2, val1]; }
                            let qHtml = `${this.makeMixedHtml(w1, n1, d1)} - ${this.makeMixedHtml(w2, n2, d2)} = ?`;
                            return { q: qHtml, a: val1 - val2, isHtml: true, isMixed: true };
                        }
                    }

                    case 'purple': {
                        const patterns = [
                            { q: "1/2 + 2/3 - 1/6 = ?", a: {n:1, d:1} },
                            { q: "1/2 + 1/4 - 1/4 = ?", a: {n:1, d:2} },
                            { q: "1/3 + 1/3 + 1/3 = ?", a: {n:1, d:1} },
                            { q: "1/2 + 1/2 + 1/2 = ?", a: {n:3, d:2} }
                        ];
                        let p = patterns[Math.floor(Math.random()*patterns.length)];
                        return { q: p.q, a: p.a, isFrac: true };
                    }

                    // [3. íƒí—˜]
                    case 'wood': { // ax Â± b = c
                        x = this.rnd(2, 9); a = this.rnd(2, 9); b = this.rnd(1, 20); 
                        if (Math.random() < 0.5) return { q: `${a}x + ${b} = ${a*x+b}`, a: x };
                        else return { q: `${a}x - ${b} = ${a*x-b}`, a: x };
                    }

                    case 'silver': { // ax Â± b = cx Â± d
                        x = this.rnd(2, 9);
                        a = this.rnd(2, 9); c = this.rnd(2, 9);
                        while(c === a) c = this.rnd(2, 9);
                        b = this.rnd(1, 10);
                        let isBPlus = Math.random() < 0.5;
                        let leftVal = a * x + (isBPlus ? b : -b);
                        let d_val = leftVal - (c * x);
                        if(d_val === 0) d_val = 1; 
                        let signB = isBPlus ? '+' : '-';
                        let signD = d_val > 0 ? '+' : '-';
                        return { q: `${a}x ${signB} ${b} = ${c}x ${signD} ${Math.abs(d_val)}`, a: x };
                    }

                    case 'gold': { // a(x Â± b) = c
                        b = this.rnd(1, 9); a = this.rnd(2, 9); 
                        if (Math.random() < 0.5) { 
                            x = this.rnd(1, 9); c = a * (x + b);
                            return { q: `${a}(x + ${b}) = ${c}`, a: x };
                        } else { 
                            x = b + this.rnd(1, 9); c = a * (x - b);
                            return { q: `${a}(x - ${b}) = ${c}`, a: x };
                        }
                    }
                    
                    default: return { q: "1 + 1 = ?", a: 2 };
                }
            }
        };

        function init() {
            const configs = [
                {rank:'gold', points:5, icon:'ğŸ†', turns:9}, {rank:'gold', points:5, icon:'ğŸ†', turns:9},
                {rank:'silver', points:3, icon:'ğŸ¥ˆ', turns:7}, {rank:'silver', points:3, icon:'ğŸ¥ˆ', turns:7}, {rank:'silver', points:3, icon:'ğŸ¥ˆ', turns:7},
                {rank:'wood', points:1, icon:'ğŸ“¦', turns:5}, {rank:'wood', points:1, icon:'ğŸ“¦', turns:5}, {rank:'wood', points:1, icon:'ğŸ“¦', turns:5}, {rank:'wood', points:1, icon:'ğŸ“¦', turns:5}, {rank:'wood', points:1, icon:'ğŸ“¦', turns:5}
            ].sort(() => Math.random() - 0.5);

            state.treasures = configs.map((cfg, i) => {
                const normal = ['red', 'blue', 'green'];
                let req = (cfg.rank === 'wood') ? [normal[Math.floor(Math.random()*3)]] :
                          (cfg.rank === 'silver') ? [...normal].sort(() => Math.random()-0.5).slice(0, 2) :
                          ['purple', normal[Math.floor(Math.random()*3)]];
                return { ...cfg, id: i, progress: 0, status: 'alive', req };
            });
            render();
        }

        function startMath(type, targetId = null) {
            closeAll();
            const prob = MathEngine.get(type);
            state.curProb = { ...prob, type, targetId };
            
            if (prob.isHtml) {
                document.getElementById('question-text').innerHTML = `Q. ${prob.q}`;
            } else {
                let displayQ = prob.q.replace(/\\frac\{(\d+)\}\{(\d+)\}/g, '$1/$2');
                document.getElementById('question-text').innerText = `Q. ${displayQ}`;
            }
            
            const normalInput = document.getElementById('input-normal');
            const fracInput = document.getElementById('input-fraction');
            const mixedInput = document.getElementById('input-mixed');

            normalInput.style.display = 'none';
            fracInput.style.display = 'none';
            mixedInput.style.display = 'none';

            if (prob.isMixed) {
                mixedInput.style.display = 'flex';
                document.getElementById('ans-mixed-whole').value = '';
                document.getElementById('ans-mixed-num').value = '';
                document.getElementById('ans-mixed-den').value = '';
            } else if (prob.isFrac) {
                fracInput.style.display = 'flex';
                document.getElementById('ans-num').value = '';
                document.getElementById('ans-den').value = '';
            } else {
                normalInput.style.display = 'block';
                document.getElementById('ans-single').value = '';
            }

            openModal('math');
        }

        function submitAnswer() {
            const p = state.curProb;
            let correct = false;
            
            if (p.isMixed) {
                const w = parseInt(document.getElementById('ans-mixed-whole').value) || 0;
                const n = parseInt(document.getElementById('ans-mixed-num').value) || 0;
                const d = parseInt(document.getElementById('ans-mixed-den').value);
                if (!isNaN(d) && d !== 0) {
                    const userVal = w + (n / d);
                    if (Math.abs(userVal - p.a) < 0.0001) correct = true;
                }
            } else if (p.isFrac) {
                const n = parseInt(document.getElementById('ans-num').value);
                const d = parseInt(document.getElementById('ans-den').value);
                if (!isNaN(n) && !isNaN(d)) correct = (n * p.a.d === d * p.a.n);
            } else {
                const ans = parseInt(document.getElementById('ans-single').value);
                if (!isNaN(ans)) correct = (ans === p.a);
            }

            if(correct) {
                alert("ì •ë‹µì…ë‹ˆë‹¤! âœ¨");
                if(['fire','ice','herb'].includes(p.type)) state.materials[p.type]++;
                else if(POTIONS[p.type]) {
                    Object.entries(POTIONS[p.type].req).forEach(([m, c]) => state.materials[m] -= c);
                    state.inv[state.inv.indexOf(null)] = p.type;
                } else {
                    if (p.targetId === state.foxTargetId) showFoxSpeech("ë‚´êº¼ì˜€ëŠ”ë°! ğŸ’¢");
                    const t = state.treasures[p.targetId];
                    t.status = 'player'; 
                    state.pScore += t.points;
                    t.req.forEach(r => state.inv[state.inv.indexOf(r)] = null);
                }
            } else alert("ì˜¤ë‹µì…ë‹ˆë‹¤! ğŸ˜¢");
            
            closeAll(); foxTurn();
        }

        function foxTurn() {
            const alive = state.treasures.filter(t => t.status === 'alive');
            if(alive.length > 0) {
                if(state.foxTargetId === null || state.treasures[state.foxTargetId].status !== 'alive') {
                    state.foxTargetId = alive[Math.floor(Math.random()*alive.length)].id;
                }
                const t = state.treasures[state.foxTargetId];
                t.progress++;
                const percent = (t.progress / t.turns) * 100;
                
                if(percent >= 100) {
                    t.status = 'fox'; state.fScore += t.points;
                    showFoxSpeech("ê³ ë§ˆì›Œ ê°€ì ¸ê°ˆê²Œ! ğŸ"); state.foxTargetId = null;
                } else if(percent >= 75) showFoxSpeech("ì €ê±´ ë‚´êº¼ì•¼! ğŸ”¥");
                else if(percent >= 50) showFoxSpeech("ì´ê±¸ë¡œ ì •í–ˆë‹¤! ğŸ¯");
                else showFoxSpeech("ë¬´ì–¸ê°€ë¥¼ ë…¸ë¦¬ê³  ìˆë‹¤...");
            }
            state.turn++; render();
        }

        function render() {
            const board = document.getElementById('game-board'); board.innerHTML = '';
            state.treasures.forEach(t => {
                const box = document.createElement('div'); box.className = 'slot-box';
                const p = (t.progress / t.turns) * 100;
                if(t.status === 'alive') {
                    if(p >= 75) box.classList.add('warning-high');
                    else if(p >= 50) box.classList.add('warning-mid');
                    box.innerHTML = `<div class="treasure-item" onclick="tryAdventure(${t.id})">${t.icon}</div><div class="req-hint">${t.req.map(r=>POTIONS[r].icon).join('')}</div>`;
                } else {
                    box.innerHTML = `<div style="font-size:30px;">${t.status === 'player' ? 'ğŸ°' : 'ğŸ¦Š'}</div>`;
                }
                board.appendChild(box);
            });
            document.getElementById('m-display').innerHTML = `ğŸ”¥ ${state.materials.fire} | â„ï¸ ${state.materials.ice} | ğŸŒ¿ ${state.materials.herb}`;
            document.getElementById('p-score').innerText = state.pScore; 
            document.getElementById('f-score').innerText = state.fScore;
            document.getElementById('turn').innerText = state.turn;
            state.inv.forEach((item, i) => {
                const slot = document.getElementById('inventory').children[i];
                slot.innerText = item ? POTIONS[item].icon : '';
                slot.className = `inv-slot ${item ? 'filled' : ''}`;
            });
        }

        function renderRecipes() {
            const container = document.getElementById('recipe-container'); container.innerHTML = '';
            Object.entries(POTIONS).forEach(([key, p]) => {
                const can = Object.entries(p.req).every(([m, c]) => state.materials[m] >= c) && state.inv.includes(null);
                container.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee; align-items:center;"><div>${p.icon} ${p.name}</div><button class="btn-main" onclick="startMath('${key}')" ${can?'':'disabled'}>ì œì‘</button></div>`;
            });
        }

        function tryAdventure(id) {
            const t = state.treasures[id];
            if(t.req.every(r => state.inv.includes(r))) startMath(t.rank, id);
            else alert("í•„ìš”í•œ ë¬¼ì•½ì´ ì—†ìŠµë‹ˆë‹¤!");
        }

        function openModal(id) { 
            document.getElementById('overlay').style.display = 'block'; 
            document.getElementById(`${id}-modal`).style.display = 'block';
            if(id === 'craft') renderRecipes();
        }
        function closeAll() { 
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); 
            document.getElementById('overlay').style.display = 'none';
            document.querySelectorAll('input').forEach(i => i.value = '');
        }
        function removeItem(i) { if(state.inv[i] && confirm("ë²„ë¦´ê¹Œìš”?")) { state.inv[i] = null; render(); } }

    </script>
</body>
</html>